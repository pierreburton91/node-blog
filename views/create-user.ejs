<!-- https://github.com/tj/ejs/issues/90 -->
<!DOCTYPE html>
<html>
<%- include('components/admin-head', {simplemde: false, title: "User registration"}); %>
<body>
<div class="container">
    <div class="editor-header">
        <h1><i class="fa fa-user-circle-o" aria-hidden="true"></i>&nbsp;User profile</h1>
        <div class="button-f-right">
			<button onclick="goBack()" class="button cancel">Cancel</button>
			<% if (typeof user != undefined) { %>
				<button onclick="submit(true)" class="button submit">Save</button>
			<% } else { %>
				<button onclick="submit(false)" class="button submit">Save</button>
			<% } %>
        </div>
    </div>
	<div class="labeled input-picture">
		<% if (typeof user != undefined) { %>
			<img id="profile-pic" src="<%= user.about.picture %>" alt="Profile picture" onclick="uploadImage(this)">
		<% } else { %>
			<img id="profile-pic" src="https://robohash.org/newuser.jpg?size=140x140&set=set2" alt="Profile picture" onclick="uploadImage(this)">
		<% } %>
    	<p>Click to upload a new image</p>
    </div>
	<h3>Account</h3>
	<% if (typeof user != undefined) { %>
		<%- include('components/input', {type: "text", id: "username", name: "username", label: "Username", value: user.account.username, hint: ""}); %>
	<% } else { %>
		<%- include('components/input', {type: "text", id: "username", name: "username", label: "Username", value: "", hint: ""}); %>
	<% } %>
    <%- include('components/input', {type: "password", id: "password", name: "password", label: "Password", value: "", hint: ""}); %>
	<%- include('components/input', {type: "password", id: "repeat-password", name: "repeat-password", label: "Repeat password", value: "", hint: ""}); %>
	<h3>About you</h3>
	<% if (typeof user != undefined) { %>
		<%- include('components/input', {type: "text", id: "firstname", name: "firstname", label: "Firstname", value: user.about.firstname, hint: ""}); %>
		<%- include('components/input', {type: "text", id: "lastname", name: "lastname", label: "Lastname", value: user.about.lastname, hint: ""}); %>
		<%- include('components/input', {type: "email", id: "email", name: "email", label: "Email address", value: user.about.email, hint: ""}); %>
		<%- include('components/input', {type: "textarea", id: "description", name: "description", label: "Your personnal description", value: user.about.description, hint: "Max 140 characters"}); %>
	<% } else { %>
		<%- include('components/input', {type: "text", id: "firstname", name: "firstname", label: "Firstname", value: "", hint: ""}); %>
		<%- include('components/input', {type: "text", id: "lastname", name: "lastname", label: "Lastname", value: "", hint: ""}); %>
		<%- include('components/input', {type: "email", id: "email", name: "email", label: "Email address", value: "", hint: ""}); %>
		<%- include('components/input', {type: "textarea", id: "description", name: "description", label: "Your personnal description", value: "", hint: "Max 140 characters"}); %>
	<% } %>
    
	<h3>About your blog</h3>
	<% if (typeof user != undefined) { %>
		<%- include('components/input', {type: "text", id: "name", name: "name", label: "Your blog's name", value: user.blog.name, hint: ""}); %>
		<%- include('components/input', {type: "textarea", id: "catchphrase", name: "catchphrase", label: "Your catchphrase", value: user.blog.catchphrase, hint: "Max 140 characters"}); %>
	<% } else { %>
		<%- include('components/input', {type: "text", id: "name", name: "name", label: "Your blog's name", value: "", hint: ""}); %>
		<%- include('components/input', {type: "textarea", id: "catchphrase", name: "catchphrase", label: "Your catchphrase", value: "", hint: "Max 140 characters"}); %>
	<% } %>
    
	<h4>Your blog categories</h4>
	<% if (typeof user != undefined) { %>
	<div class="editor-categories">
		<% user.blog.categories.forEach(function(cat){ %>
			<div class="category-item"><%= cat %><span>x</span></div>
		<% }); %>
    </div>
	<% } else { %>
	<div class="editor-categories">
    </div>
	<% } %>
    
    <%- include('components/input', {type: "text", id: "category", name: "category", label: "Add a new category", value: "", hint: "Validate with \"Enter\" key"}); %>
</div>
<%- include('components/upload-image'); %>
<script src="https://use.fontawesome.com/973262919d.js"></script>
<script type="text/javascript" src="../scripts/closest-polyfill.js"></script>
<script type="text/javascript" src="../scripts/promise-polyfill.min.js"></script>
<script type="text/javascript" src="../scripts/utilities.js"></script>
<script type="text/javascript">

	var catInput = document.querySelector('#category'),
		catItems = document.querySelector('.editor-categories'),
		categories = [];

	if(document.querySelectorAll('.category-item') != undefined) {
		var categoryList = document.querySelectorAll('.category-item');
		for (i = 0; i < categoryList.length; i++) {
			categories.push(categoryList[i].childNodes[0].nodeValue);
		}
	}
	
	catInput.addEventListener('keyup', function(e) {
		if (e.keyCode == 13) {
			var value = e.target.value;
			
	        // Prevent duplicates
	        if (categories.indexOf(value) != -1) {
	        	var popUpInfos = {"type": "info", "text": "This category already exists."};
                displayPop(popUpInfos);
                catInput.value = "";
                return false;
	        }

	        var	catBox = document.createElement('div'),
	            catBoxText = document.createTextNode(value),
	            closeButton = document.createElement('span'),
	            closeCross = document.createTextNode('x');

	        closeButton.appendChild(closeCross);
	        catBox.appendChild(catBoxText);
	        catBox.appendChild(closeButton);
	        catBox.classList.add("category-item");
	        catItems.appendChild(catBox);
	        categories.push(value);
	        catInput.value = "";
	        location.href = "#category";
		}
	});

	catItems.addEventListener('click', function(e) {
		if(e.target && e.target.nodeName == "SPAN") {
			var currentCat = e.path[1].childNodes[0].data,
				catToDelete = categories.indexOf(currentCat);

			catItems.removeChild(catItems.childNodes[catToDelete + 1]);
        	categories.splice(catToDelete, 1);
		}
	});

	function submit(update) {
		var username = document.querySelector('#username').value,
			password = document.querySelector('#password').value,
			repeatPassword = document.querySelector('#repeat-password').value,
			firstname = document.querySelector('#firstname').value,
			lastname = document.querySelector('#lastname').value,
			picture = document.querySelector('#profile-pic').src,
			email = document.querySelector('#email').value,
			description = document.querySelector('#description').value,
			name = document.querySelector('#name').value,
			catchphrase = document.querySelector('#catchphrase').value,
			data;

		if (!username) {
			var popUpInfos = {"type": "error", "text": "You must choose a username."};
            displayPop(popUpInfos);
            document.querySelector('#username').focus();

		}
		else if (password.length < 8 && update == false && password != '') {
			var popUpInfos = {"type": "error", "text": "Your password must contain at least 8 characters."};
            displayPop(popUpInfos);
            document.querySelector('#password').focus();
		}
		else if (password != repeatPassword) {
			var popUpInfos = {"type": "error", "text": "Passwords don't match."};
            displayPop(popUpInfos);
            document.querySelector('#repeat-password').focus();
		}
		else if (!email || !document.querySelector('#email').checkValidity()) {
			var popUpInfos = {"type": "error", "text": "You must provide a valid email address."};
            displayPop(popUpInfos);
            document.querySelector('#email').focus();
		}
		else if (!name) {
			var popUpInfos = {"type": "error", "text": "Your blog must have a name."};
            displayPop(popUpInfos);
            document.querySelector('#name').focus();
		}
		else if (categories.length == 0) {
			var popUpInfos = {"type": "error", "text": "Your blog should at least have 1 category."};
            displayPop(popUpInfos);
            document.querySelector('#category').focus();
		}
		else {
			data = {
				account: {
					username: document.querySelector('#username').value,
			    	password: document.querySelector('#password').value
				},
			    about: {
			        firstname: document.querySelector('#firstname').value,
			        lastname: document.querySelector('#lastname').value,
			        picture: document.querySelector('#profile-pic').src,
			        email: document.querySelector('#email').value,
			        description: document.querySelector('#description').value,
			        social: {
			            facebook: '',
			            twitter: '',
			            google: '',
			            instagram: '',
			            pinterest: '',
			            youtube: '',
			            vimeo: '',
			            medium: '',
			            github: '',
			            dribbble: '',
			            behance: ''
			        }
			    },
			    blog: {
			        name: document.querySelector('#name').value,
			        url: '',
			        logo: '',
			        catchphrase: document.querySelector('#catchphrase').value,
			        categories: categories,
			        social: {
			            facebook: '',
			            twitter: '',
			            google: '',
			            instagram: '',
			            pinterest: '',
			            youtube: '',
			            vimeo: '',
			            medium: '',
			            github: '',
			            dribbble: '',
			            behance: ''
			        }
			    }
			};

			var xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        var response = JSON.parse(this.responseText),
                        	isSuccess = response.success,
                        	message = response.message;
                        
                        if (isSuccess) {
                        	var popUpInfos = {"type": "success", "text": "The operation succeeded ! " + message +"" };
            				displayPop(popUpInfos);
            				setTimeout(function(){window.location.href = "/";}, 2000);
                        }
                        else {
                        	var popUpInfos = {"type": "warning", "text": "An error occured. Please contact the support." };
            				displayPop(popUpInfos);
                        }
                        
                    }
                    else {
                        console.log(this.status, this.statusText, this.getAllResponseHeaders());
                        var popUpInfos = {"type": "error", "text": "Internal server error. Please contact the support." };
            			displayPop(popUpInfos);
                    }
                }
			}
			if (update != true) {
				xhr.open("POST", "/api/signup", true);
			} else {
				xhr.open("PUT", "/api/update-profile", true);
			}
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify(data));
		}
	}

	function goBack() {
        window.location.href = "/";
	}
</script>
<% if (message.length > 0) { %>
    <script type="text/javascript">
            var popUpInfos = {"type": "error", "text": message };
            displayPop(popUpInfos);
    </script>
<% } %>
</body>
</html>